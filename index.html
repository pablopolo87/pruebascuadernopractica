<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cuaderno de Prácticas FCT — Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kalam:wght@300;400;700&family=Architects+Daughter&display=swap');
    
    :root {
      --notebook-bg: #FDFDF8;
      --line-color: #E8E8E8;
      --margin-color: #FFB3B3;
      --primary-accent: #4338ca;
    }

    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #e5e7eb; /* gray-200 */
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1d5db' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    .font-handwriting { font-family: 'Kalam', cursive; }
    .font-notes { font-family: 'Architects Daughter', cursive; }

    .hidden { display: none; }
    .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: var(--primary-accent); animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .toast { position: fixed; bottom: 20px; right: 20px; transform: translateX(120%); padding: 16px 24px; border-radius: 8px; color: white; z-index: 100; transition: transform 0.4s ease-in-out; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); border: 1px solid rgba(255,255,255,0.2); }
    .toast.show { transform: translateX(0); }
    
    .notebook-container {
      background-color: var(--notebook-bg);
      background-image: 
        linear-gradient(to right, transparent 59px, var(--margin-color) 59px, var(--margin-color) 61px, transparent 61px),
        repeating-linear-gradient(var(--notebook-bg), var(--notebook-bg) 2.4em, var(--line-color) 2.4em, var(--line-color) calc(2.4em + 1px));
      line-height: 2.4em;
      position: relative;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.35);
    }
    
    .styled-input, .styled-textarea, .styled-select {
      background: transparent;
      border: none;
      border-bottom: 2px solid #d1d5db; /* gray-300 */
      border-radius: 0;
      padding: 0.5em 0.2em;
      line-height: 1.5em;
      font-family: 'Architects Daughter', cursive;
      font-size: 1.1rem;
      color: #1e293b; /* slate-800 */
      transition: border-color 0.2s;
    }
    .styled-input:focus, .styled-textarea:focus, .styled-select:focus {
      outline: none;
      box-shadow: none !important;
      border-color: var(--primary-accent) !important;
      --tw-ring-shadow: none !important;
    }
    .styled-textarea {
        resize: vertical;
        min-height: 120px;
    }

    .tab-button { transition: all 0.2s; border-bottom: 3px solid transparent; padding-bottom: 8px;}
    .tab-button.active { border-color: var(--primary-accent); color: var(--primary-accent); font-weight: 600; }
  </style>
</head>
<body class="text-slate-900">
  <div id="app" class="p-4 md:p-8">
    <!-- VISTA DE CARGA -->
    <div id="loading-view" class="flex flex-col items-center justify-center min-h-screen">
      <div class="spinner !w-12 !h-12"></div>
      <p class="mt-4 text-slate-500 font-semibold">Cargando cuaderno...</p>
    </div>

    <!-- VISTA DE LOGIN -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center">
      <div class="w-full max-w-md" role="form" aria-labelledby="login-title">
        <header class="text-center mb-8">
          <i class="fas fa-book-open-reader text-6xl text-indigo-800" aria-hidden="true"></i>
          <h1 id="login-title" class="font-handwriting text-5xl font-bold text-slate-800 mt-4">Cuaderno de Prácticas</h1>
          <p class="text-slate-500 mt-2 text-lg">Inicia sesión para empezar a escribir.</p>
        </header>
        <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg border border-slate-200">
          <form id="login-form">
            <div class="space-y-4">
              <label class="block">
                <span class="font-semibold text-slate-700">Email</span>
                <input type="email" id="login-email" value="alumno@test.com" class="mt-1 w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required />
              </label>
              <label class="block">
                <span class="font-semibold text-slate-700">Contraseña</span>
                <input type="password" id="login-password" value="123456" class="mt-1 w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required />
              </label>
            </div>
            <button type="submit" id="login-button" class="mt-6 w-full bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-800 transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center">
              <span id="login-btn-text">Iniciar Sesión</span>
              <div id="login-spinner" class="spinner hidden ml-2"></div>
            </button>
          </form>
          <p class="text-xs text-slate-400 mt-4 text-center">¿No tienes cuenta? Contacta con tu tutor para el alta.</p>
        </div>
      </div>
    </div>

    <!-- VISTA PRINCIPAL DE LA APP -->
    <div id="main-app-view" class="hidden max-w-7xl mx-auto">
        <div class="notebook-container rounded-lg p-8 pl-20 relative">

          <!-- VISTA ALUMNO -->
          <div id="student-view" class="hidden">
            <header class="flex flex-wrap items-center justify-between gap-4 mb-8 pb-4 border-b-2 border-dashed">
              <div>
                <h1 class="text-4xl font-handwriting text-slate-800">Mi Cuaderno</h1>
                <p id="student-welcome" class="text-slate-500 font-notes text-lg">Bienvenido/a.</p>
              </div>
              <button id="logout-btn-student" class="bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-red-700 shadow-md transition-transform transform hover:scale-105"><i class="fas fa-sign-out-alt mr-2" aria-hidden="true"></i>Cerrar Sesión</button>
            </header>
            
            <div class="border-b border-slate-200 mb-6">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-student-dashboard" class="tab-button active text-lg">Resumen</button>
                    <button id="tab-student-new" class="tab-button text-lg">Nuevo Parte</button>
                    <button id="tab-student-diary" class="tab-button text-lg">Diario Semanal</button>
                    <button id="tab-student-history" class="tab-button text-lg">Historial</button>
                    <button id="tab-student-memory" class="tab-button text-lg">Memoria Final</button>
                </nav>
            </div>

            <div id="student-tab-content">
                <!-- PANEL ALUMNO -->
                <div id="student-dashboard-view">
                    <h2 class="text-3xl font-handwriting text-slate-800 mb-4">Resumen General</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-bold font-handwriting text-slate-700 mb-3">Ficha de Prácticas</h3>
                            <div id="practice-info-content" class="space-y-4 font-notes text-lg text-slate-700"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold font-handwriting text-slate-700 mb-3">Estadísticas</h3>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="bg-indigo-100/50 p-4 rounded-lg border border-indigo-200">
                                <p class="text-3xl font-bold text-indigo-600" id="stat-student-hours">0.00</p>
                                <p class="text-sm text-slate-500 font-semibold">Horas Totales</p>
                                </div>
                                <div class="bg-emerald-100/50 p-4 rounded-lg border border-emerald-200">
                                <p class="text-3xl font-bold text-emerald-600" id="stat-student-attended">0</p>
                                <p class="text-sm text-slate-500 font-semibold">Días Asistidos</p>
                                </div>
                                <div class="bg-red-100/50 p-4 rounded-lg border border-red-200">
                                <p class="text-3xl font-bold text-red-600" id="stat-student-absences">0</p>
                                <p class="text-sm text-slate-500 font-semibold">Ausencias</p>
                                </div>
                                <div class="bg-amber-100/50 p-4 rounded-lg border border-amber-200">
                                <p class="text-3xl font-bold text-amber-700" id="stat-student-pending">0</p>
                                <p class="text-sm text-slate-500 font-semibold">Partes Pendientes</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FORMULARIO NUEVA PRÁCTICA -->
                <div id="student-new-view" class="hidden">
                  <h2 class="text-3xl font-handwriting text-slate-800 mb-6">Nuevo Registro de Práctica</h2>
                  <form id="practice-form" class="space-y-8" novalidate>
                      <div class="grid md:grid-cols-2 gap-x-8 gap-y-4">
                        <label class="block"><span class="font-semibold text-slate-700">Empresa / Entidad</span><input type="text" id="company-name" class="styled-input mt-1 block w-full" required minlength="2" maxlength="100" /></label>
                        <label class="block"><span class="font-semibold text-slate-700">Fecha</span><input type="date" id="practice-date" class="styled-input mt-1 block w-full text-slate-500" required /></label>
                      </div>
                      <div class="relative flex items-start bg-amber-50 p-4 rounded-lg border border-amber-200">
                        <div class="flex h-6 items-center"><input id="absence-checkbox" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" /></div>
                        <div class="ml-3 text-sm leading-6"><label for="absence-checkbox" class="font-medium text-gray-900">No he podido asistir</label><p class="text-gray-500">Marca esta casilla si has faltado.</p></div>
                      </div>
                      <div id="attendance-fields" class="space-y-8">
                        <div class="grid md:grid-cols-2 gap-x-8 gap-y-4">
                          <label class="block"><span class="font-semibold text-slate-700">Hora de Entrada</span><input type="time" id="start-time" class="styled-input mt-1 block w-full text-slate-500" /></label>
                          <label class="block"><span class="font-semibold text-slate-700">Hora de Salida</span><input type="time" id="end-time" class="styled-input mt-1 block w-full text-slate-500" /></label>
                        </div>
                        <div><label class="block"><span class="font-semibold text-slate-700">Actividad Realizada</span><textarea id="activity-description" rows="4" class="styled-textarea mt-1 block w-full" maxlength="1000"></textarea></label></div>
                      </div>
                      <div id="absence-fields" class="hidden space-y-8">
                        <label class="block"><span class="font-semibold text-slate-700">Motivo de la Ausencia</span><textarea id="absence-reason" rows="3" class="styled-textarea mt-1 block w-full" maxlength="500"></textarea></label>
                        <label class="block"><span class="font-semibold text-slate-700">Adjuntar Justificante (Opcional)</span><input type="file" id="absence-file" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/></label>
                      </div>
                      <div class="flex flex-wrap gap-4 justify-between items-center pt-6">
                        <div class="flex items-center gap-6"><span class="text-xl font-bold text-slate-700">Horas: <span id="hours-computed" class="text-indigo-600">0.00</span></span><span id="warning-message" class="text-sm text-red-600 hidden"><i class="fa-solid fa-triangle-exclamation mr-1"></i><span>Revisa horas/fecha.</span></span></div>
                        <div class="flex items-center gap-3">
                          <button type="reset" id="reset-button" class="bg-slate-200 text-slate-800 font-semibold py-3 px-5 rounded-lg hover:bg-slate-300 shadow-sm transition-transform transform hover:scale-105">Limpiar</button>
                          <button type="submit" id="submit-button" class="bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-800 flex items-center disabled:opacity-60 disabled:cursor-not-allowed shadow-lg transition-transform transform hover:scale-105"><span id="submit-button-text"><i class="fas fa-check mr-2" aria-hidden="true"></i>Guardar</span><div id="submit-spinner" class="spinner hidden ml-2" style="border-width: 2px"></div></button>
                        </div>
                      </div>
                  </form>
                </div>
                
                <div id="student-history-view" class="hidden">
                  <h2 class="text-3xl font-handwriting text-slate-800 mb-4">Mi Historial de Registros</h2>
                  <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-700 uppercase"><tr><th class="px-6 py-3">Fecha</th><th class="px-6 py-3">Empresa</th><th class="px-6 py-3">Horas</th><th class="px-6 py-3">Actividad/Motivo</th><th class="px-6 py-3">Estado</th></tr></thead><tbody id="student-history-tbody"></tbody></table></div>
                </div>

                <div id="student-diary-view" class="hidden">
                    <h2 class="text-3xl font-handwriting text-slate-800 mb-4">Diario Semanal</h2>
                    <form id="diary-form" class="mb-6 space-y-4">
                        <label class="block"><span class="font-semibold text-slate-700">Fecha</span><input type="date" id="diary-date" class="styled-input mt-1 block w-full" required /></label>
                        <label class="block"><span class="font-semibold text-slate-700">Descripción de Tareas y Observaciones</span><textarea id="diary-description" rows="3" class="styled-textarea mt-1 block w-full" required placeholder="Describe las actividades que has realizado hoy..."></textarea></label>
                        <div class="text-right pt-4">
                           <button type="submit" class="bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-800 shadow-md transition-transform transform hover:scale-105">Añadir Entrada</button>
                        </div>
                    </form>
                    <div id="diary-entries" class="space-y-4"></div>
                </div>
                
                <div id="student-memory-view" class="hidden">
                    <h2 class="text-3xl font-handwriting text-slate-800 mb-4">Redactar Memoria Final</h2>
                    <form id="memory-form" class="space-y-8">
                        <label class="block"><span class="font-semibold text-slate-700">1. Breve Descripción de la Empresa</span><textarea id="memory-company" rows="4" class="styled-textarea mt-1 block w-full" placeholder="Actividad, tamaño, ubicación..."></textarea></label>
                        <label class="block"><span class="font-semibold text-slate-700">2. Resumen de Tareas y Actividades Realizadas</span><textarea id="memory-tasks" rows="6" class="styled-textarea mt-1 block w-full" placeholder="Describe los proyectos en los que has participado y las funciones que has desempeñado."></textarea></label>
                        <label class="block"><span class="font-semibold text-slate-700">3. Competencias y Conocimientos Adquiridos</span><textarea id="memory-skills" rows="5" class="styled-textarea mt-1 block w-full" placeholder="¿Qué nuevas habilidades técnicas o personales has desarrollado?"></textarea></label>
                        <label class="block"><span class="font-semibold text-slate-700">4. Valoración Personal y Conclusiones</span><textarea id="memory-conclusion" rows="5" class="styled-textarea mt-1 block w-full" placeholder="Reflexiona sobre la experiencia, dificultades encontradas, y cómo ha contribuido a tu formación."></textarea></label>
                        <div class="text-right pt-4">
                           <button type="submit" class="bg-emerald-600 text-white font-semibold py-3 px-5 rounded-lg hover:bg-emerald-700 shadow-md transition-transform transform hover:scale-105"><i class="fas fa-file-pdf mr-2"></i>Generar Memoria</button>
                        </div>
                    </form>
                </div>
            </div>
          </div>

          <!-- VISTA TUTOR -->
          <div id="tutor-view" class="hidden">
            <header class="flex flex-wrap items-center justify-between gap-4 mb-8 pb-4 border-b-2 border-dashed">
              <div><h1 class="text-4xl font-handwriting text-slate-800">Panel de Tutor</h1><p id="tutor-welcome" class="text-slate-500 font-notes text-lg">Gestionando partes de los alumnos.</p></div>
              <div class="flex items-center gap-4"><select id="aula-selector" class="rounded-lg border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select><button id="logout-btn-tutor" class="bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-red-700 shadow-md transition-transform transform hover:scale-105"><i class="fas fa-sign-out-alt mr-2" aria-hidden="true"></i>Cerrar Sesión</button></div>
            </header>
            
            <div class="border-b border-slate-200 mb-6">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-tutor-records" class="tab-button active text-lg">Registros</button>
                    <button id="tab-tutor-onboarding" class="tab-button text-lg">Plan de Acogida</button>
                </nav>
            </div>

            <div id="tutor-tab-content">
                <div id="tutor-records-view">
                    <div class="bg-slate-100/70 p-4 rounded-xl border mb-6">
                        <div class="grid md:grid-cols-5 gap-4">
                            <input type="text" id="filter-student" placeholder="Buscar por alumno..." class="rounded-lg border-slate-300 shadow-sm" /><input type="text" id="filter-company" placeholder="Buscar por empresa..." class="rounded-lg border-slate-300 shadow-sm" /><input type="date" id="filter-date-from" class="rounded-lg border-slate-300 text-slate-500 shadow-sm" /><input type="date" id="filter-date-to" class="rounded-lg border-slate-300 text-slate-500 shadow-sm" /><div class="flex gap-2"><button id="clear-filters" class="w-full bg-slate-300 text-slate-800 font-semibold rounded-lg hover:bg-slate-400 shadow-sm transition-colors">Limpiar</button></div>
                        </div>
                        <div class="flex flex-wrap gap-4 justify-between items-center mt-4 pt-4 border-t">
                            <div class="flex gap-4 text-sm font-semibold text-slate-600"><span>Registros: <b id="stat-total-records" class="text-indigo-600">0</b></span><span>Horas Totales: <b id="stat-total-hours" class="text-indigo-600">0.00</b></span><span>Ausencias: <b id="stat-total-absences" class="text-red-600">0</b></span></div>
                            <div class="flex gap-2"><button id="export-csv-btn" class="bg-emerald-600 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 shadow-md transition-transform transform hover:scale-105"><i class="fas fa-file-csv mr-2" aria-hidden="true"></i>Exportar CSV</button></div>
                        </div>
                    </div>
                    <div class="overflow-x-auto mt-4"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-700 uppercase"><tr><th class="px-6 py-3">Alumno</th><th class="px-6 py-3">Fecha</th><th class="px-6 py-3">Empresa</th><th class="px-6 py-3">Horas</th><th class="px-6 py-3">Actividad/Motivo</th><th class="px-6 py-3">Estado</th><th class="px-6 py-3 text-right">Acciones</th></tr></thead><tbody id="records-tbody"></tbody></table></div>
                    <div class="flex items-center justify-end gap-3 mt-4" id="pagination"><button id="prev-page" class="px-3 py-1 rounded border bg-white shadow-sm text-slate-700 disabled:opacity-40">Anterior</button><span id="page-indicator" class="text-sm text-slate-600 font-semibold">Página 1</span><button id="next-page" class="px-3 py-1 rounded border bg-white shadow-sm text-slate-700 disabled:opacity-40">Siguiente</button></div>
                </div>

                <div id="tutor-onboarding-view" class="hidden">
                    <h2 class="text-3xl font-handwriting text-slate-800 mb-4">Plan de Acogida del Alumno</h2>
                    <p class="text-slate-600 mb-6 font-notes text-lg">Una buena bienvenida es el primer paso para una gran experiencia. Usa esta guía de referencia.</p>
                    <div id="onboarding-plan-content" class="space-y-6"></div>
                </div>
            </div>
          </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="confirm-delete-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl text-center"><div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100"><i class="fas fa-exclamation-triangle text-2xl text-red-600" aria-hidden="true"></i></div><h2 id="delete-title" class="text-xl font-bold mt-4">Eliminar Registro</h2><p class="text-slate-500 mt-2">¿Estás seguro? Esta acción no se puede deshacer.</p><div class="mt-6 flex justify-center gap-4"><button id="cancel-delete-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 focus-ring">Cancelar</button><button id="confirm-delete-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 focus-ring">Eliminar</button></div></div></div>
    <div id="edit-record-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="bg-white w-full max-w-2xl p-8 rounded-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto"><button id="close-edit-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800" aria-label="Cerrar"><i class="fas fa-times text-xl" aria-hidden="true"></i></button><h2 id="edit-title" class="text-2xl font-bold mb-6">Editar Registro</h2><form id="edit-form" class="space-y-4"><input type="hidden" id="edit-record-id" /><div class="grid md:grid-cols-2 gap-4"><label class="block"><span class="font-semibold text-slate-700">Nombre Alumno</span><input type="text" id="edit-student-name" class="mt-1 block w-full rounded-lg border-slate-300 bg-slate-100" readonly /></label><label class="block"><span class="font-semibold text-slate-700">Empresa</span><input type="text" id="edit-company-name" class="mt-1 block w-full rounded-lg border-slate-300" required /></label></div><label class="block"><span class="font-semibold text-slate-700">Fecha</span><input type="date" id="edit-practice-date" class="mt-1 block w-full rounded-lg border-slate-300" required /></label><div class="grid md:grid-cols-3 gap-4 items-end"><label class="block"><span class="font-semibold text-slate-700">Hora Entrada</span><input type="time" id="edit-start-time" class="mt-1 block w-full rounded-lg border-slate-300" /></label><label class="block"><span class="font-semibold text-slate-700">Hora Salida</span><input type="time" id="edit-end-time" class="mt-1 block w-full rounded-lg border-slate-300" /></label><label class="block"><span class="font-semibold text-slate-700">Horas</span><input type="number" step="0.01" id="edit-hours" class="mt-1 block w-full rounded-lg border-slate-300 bg-slate-100" readonly /></label></div><div class="grid md:grid-cols-2 gap-4"><label class="block"><span class="font-semibold text-slate-700">Estado</span><select id="edit-status" class="mt-1 block w-full rounded-lg border-slate-300"><option>Pendiente</option><option>Validado</option><option>Requiere Revisión</option></select></label><label class="block"><span id="edit-activity-label" class="font-semibold text-slate-700">Actividad / Motivo Ausencia</span><textarea id="edit-activity" rows="4" class="mt-1 block w-full rounded-lg border-slate-300"></textarea></label></div><div class="flex justify-end"><button type="submit" class="mt-2 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center"><span id="edit-btn-text">Guardar Cambios</span><div id="edit-spinner" class="spinner hidden ml-2"></div></button></div></form></div></div>
    <div id="evaluation-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="bg-white w-full max-w-2xl p-8 rounded-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto"><button id="close-evaluation-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800" aria-label="Cerrar"><i class="fas fa-times text-xl"></i></button><h2 class="text-2xl font-bold mb-2">Evaluar Registro</h2><p class="text-slate-500 mb-6">Valoración de competencias para <b id="evaluation-student-name"></b></p><form id="evaluation-form" class="space-y-4"><input type="hidden" id="evaluation-record-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4"><div><label for="eval-responsabilidad" class="font-semibold text-slate-700">Responsabilidad</label><p class="text-xs text-slate-500 mb-1">Cumple tareas y horarios.</p><input type="range" id="eval-responsabilidad" min="1" max="10" class="w-full"></div><div><label for="eval-iniciativa" class="font-semibold text-slate-700">Iniciativa y Autonomía</label><p class="text-xs text-slate-500 mb-1">Muestra proactividad y resuelve problemas.</p><input type="range" id="eval-iniciativa" min="1" max="10" class="w-full"></div><div><label for="eval-equipo" class="font-semibold text-slate-700">Trabajo en Equipo</label><p class="text-xs text-slate-500 mb-1">Colabora y se integra con compañeros.</p><input type="range" id="eval-equipo" min="1" max="10" class="w-full"></div><div><label for="eval-comunicacion" class="font-semibold text-slate-700">Comunicación</label><p class="text-xs text-slate-500 mb-1">Se expresa con claridad y respeto.</p><input type="range" id="eval-comunicacion" min="1" max="10" class="w-full"></div></div><div class="pt-4"><label class="block"><span class="font-semibold text-slate-700">Comentarios Adicionales del Tutor</span><textarea id="eval-comentarios" rows="3" class="mt-1 block w-full rounded-lg border-slate-300"></textarea></label></div><div class="flex justify-end"><button type="submit" class="mt-2 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700">Guardar Evaluación</button></div></form></div></div>
    <div id="diary-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="bg-white w-full max-w-3xl p-8 rounded-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto"><button id="close-diary-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800" aria-label="Cerrar"><i class="fas fa-times text-xl"></i></button><h2 class="text-2xl font-bold mb-2">Diario Semanal de <span id="diary-modal-student-name"></span></h2><div id="diary-modal-content" class="mt-6 space-y-4"></div></div></div>
  </div>

  <div id="toast-notification" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // ---- ENTORNO SIMULADO DE SUPABASE ----
    const createMockSupabase = () => {
        const MOCK_DB = {
            aulas: [ { id: 1, nombre: '2º DAW' }, { id: 2, nombre: '2º DAM' } ],
            profiles: [
                { id: 'tutor-1', email: 'tutor@test.com', full_name: 'Laura García (Tutor)', role: 'tutor', managed_aulas: [{ id: 1, nombre: '2º DAW' }, { id: 2, nombre: '2º DAM' }] },
                { id: 'student-1', email: 'alumno@test.com', full_name: 'Elena Campos', role: 'student', aula_id: 1, practice_info: { course: 'Desarrollo de Aplicaciones Web', company_tutor: 'Marcos Soler', center_tutor: 'Isabel Jiménez', start_date: '2024-09-01', end_date: '2025-06-15'} },
                { id: 'student-2', email: 'otro@test.com', full_name: 'Pedro Morales', role: 'student', aula_id: 1, practice_info: { course: 'Desarrollo de Aplicaciones Web', company_tutor: 'Ana Torres', center_tutor: 'Isabel Jiménez', start_date: '2024-09-01', end_date: '2025-06-15'} },
                { id: 'student-3', email: 'dam@test.com', full_name: 'Ana Juarez', role: 'student', aula_id: 2, practice_info: { course: 'Desarrollo de Aplicaciones Multiplataforma', company_tutor: 'Luis Navarro', center_tutor: 'Carlos Pons', start_date: '2024-09-01', end_date: '2025-06-15'} },
            ],
            practicas: [
                { id: 101, alumno_id: 'student-1', aula_id: 1, companyName: 'Innovatec Solutions', practiceDate: '2024-09-02', isAbsent: false, startTime: '09:00', endTime: '17:00', hours: 8, activity: 'Desarrollo de componentes UI.', status: 'Validado', evaluation: { responsabilidad: 9, iniciativa: 8, equipo: 9, comunicacion: 7, comentarios: 'Muy buena adaptación.'} },
                { id: 102, alumno_id: 'student-1', aula_id: 1, companyName: 'Innovatec Solutions', practiceDate: '2024-09-03', isAbsent: false, startTime: '09:00', endTime: '14:00', hours: 5, activity: 'Refactorización de código.', status: 'Pendiente', evaluation: null },
                { id: 103, alumno_id: 'student-2', aula_id: 1, companyName: 'Data Corp', practiceDate: '2024-09-02', isAbsent: false, startTime: '08:30', endTime: '16:30', hours: 8, activity: 'Creación de scripts SQL.', status: 'Validado', evaluation: { responsabilidad: 10, iniciativa: 7, equipo: 8, comunicacion: 8, comentarios: 'Excelente trabajo.'} },
                { id: 104, alumno_id: 'student-2', aula_id: 1, companyName: 'Data Corp', practiceDate: '2024-09-04', isAbsent: true, absenceReason: 'Cita médica', hours: 0, status: 'Requiere Revisión', attachedFile: 'justificante_medico.pdf', evaluation: { responsabilidad: 5, iniciativa: 5, equipo: 5, comunicacion: 5, comentarios: 'Falta injustificada inicialmente.'} },
                { id: 105, alumno_id: 'student-3', aula_id: 2, companyName: 'Mobile First', practiceDate: '2024-09-05', isAbsent: false, startTime: '10:00', endTime: '18:00', hours: 8, activity: 'Testing de la nueva app.', status: 'Pendiente', evaluation: null },
            ],
            diario_semanal: [
                { id: 1, alumno_id: 'student-1', date: '2024-09-02', description: 'He aprendido a usar los hooks de estado en React y he completado el componente de perfil de usuario.', tutor_comment: '¡Buen trabajo! Sigue así.' },
                { id: 2, alumno_id: 'student-1', date: '2024-09-03', description: 'Hoy estuve optimizando las consultas a la base de datos. Se logró una mejora del 15% en el tiempo de carga.', tutor_comment: null },
            ]
        };
        let currentSession = null;
        let authStateChangeCallback = () => {};
        let dbChangeCallback = () => {};
        const mockSupabase = {
            auth: {
                onAuthStateChange: (c) => { authStateChangeCallback = c; setTimeout(() => c('INITIAL_STATE', currentSession), 100); return { data: { subscription: 'mock-sub' } }; },
                signInWithPassword: async ({ email }) => {
                    const profile = MOCK_DB.profiles.find(p => p.email === email);
                    if (profile) { currentSession = { user: { id: profile.id, email: profile.email } }; setTimeout(() => authStateChangeCallback('SIGNED_IN', currentSession), 100); return { data: { session: currentSession }, error: null }; }
                    return { data: { session: null }, error: { message: 'Credenciales inválidas' } };
                },
                signOut: async () => { currentSession = null; setTimeout(() => authStateChangeCallback('SIGNED_OUT', null), 100); return { error: null }; },
            },
            from: (tableName) => ({
                _query: {},
                select: function(q='*') { this._query.q = q; return this; },
                insert: async function(records) { records.forEach(r => { const newId = MOCK_DB[tableName].length > 0 ? Math.max(...MOCK_DB[tableName].map(i => i.id)) + 1 : 1; MOCK_DB[tableName].push({ ...r, id: newId }); }); setTimeout(dbChangeCallback, 50); return { error: null }; },
                update: function(data) { this._query.updateData = data; return this; },
                delete: function() { this._query.isDelete = true; return this; },
                eq: function(col, val) { this._query.filter = { [col]: val, ...(this._query.filter || {}) }; return this; },
                order: function(col, { ascending }) { this._query.order = { col, ascending }; return this; },
                single: function() { this._query.single = true; return this; },
                then: async function(resolve) {
                    let results = [...MOCK_DB[tableName]];
                    if (this._query.filter) results = results.filter(row => Object.entries(this._query.filter).every(([k, v]) => row[k] == v));
                    
                    if (this._query.isDelete) {
                        const idsToDelete = new Set(results.map(r => r.id));
                        MOCK_DB[tableName] = MOCK_DB[tableName].filter(r => !idsToDelete.has(r.id));
                        setTimeout(dbChangeCallback, 50);
                        return resolve({ error: null });
                    }
                    if (this._query.updateData) {
                        const idsToUpdate = new Set(results.map(r => r.id));
                        MOCK_DB[tableName].forEach((r, i) => { if(idsToUpdate.has(r.id)) MOCK_DB[tableName][i] = { ...r, ...this._query.updateData }; });
                        setTimeout(dbChangeCallback, 50);
                        return resolve({ error: null });
                    }

                    if (tableName === 'practicas' && this._query.q.includes('profiles')) { results = results.map(p => ({ ...p, profile: MOCK_DB.profiles.find(prof => prof.id === p.alumno_id) })); }
                    if (this._query.order) { results.sort((a, b) => (a[this._query.order.col] > b[this._query.order.col] ? 1 : -1) * (this._query.order.ascending ? 1 : -1)); }
                    
                    if (this._query.single) return resolve({ data: results[0] || null, error: null });
                    
                    resolve({ data: results, error: null });
                }
            }),
            channel: (name) => ({ on: (evt, cfg, cb) => { dbChangeCallback = cb; return { subscribe: (s_cb) => { if (s_cb) setTimeout(s_cb, 50); } }; } }),
            removeChannel: () => { dbChangeCallback = () => {}; }
        };
        return mockSupabase;
    };
    
    const supabase = createMockSupabase();

    // ---- REFERENCIAS DOM Y ESTADO ----
    const DOM = {
      loadingView: document.getElementById('loading-view'), loginView: document.getElementById('login-view'), mainAppView: document.getElementById('main-app-view'), studentView: document.getElementById('student-view'), tutorView: document.getElementById('tutor-view'),
      confirmDeleteModal: document.getElementById('confirm-delete-modal'), editRecordModal: document.getElementById('edit-record-modal'), evaluationModal: document.getElementById('evaluation-modal'), diaryModal: document.getElementById('diary-modal'), toast: document.getElementById('toast-notification'), aulaSelector: document.getElementById('aula-selector'),
    };
    const statusStyles = { 'Pendiente': 'bg-yellow-100 text-yellow-800', 'Validado': 'bg-green-100 text-green-800', 'Requiere Revisión': 'bg-red-100 text-red-800', 'default': 'bg-slate-100 text-slate-800' };
    const PAGE_SIZE = 10;
    let currentUserProfile = null, recordsSubscription = null, allTutorRecords = [], currentPage = 1, recordIdToMutate = null;

    // ---- HELPERS ----
    const showToast = (message, className = 'bg-slate-900') => { DOM.toast.textContent = message; DOM.toast.className = `toast show ${className}`; setTimeout(() => { DOM.toast.className = 'toast'; }, 4000); };
    const switchOnlyMainViews = (which) => { [DOM.loadingView, DOM.loginView, DOM.mainAppView].forEach(el => el.classList.add('hidden')); if (DOM[which]) DOM[which].classList.remove('hidden'); };
    const escapeHTML = (str = '') => String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
    const debounce = (fn, ms = 250) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; };
    const computeDiffHours = (start, end) => !start || !end ? 0 : Math.max(0, (new Date(`1970-01-01T${end}`) - new Date(`1970-01-01T${start}`)) / 36e5);
    const todayISO = () => new Date().toISOString().slice(0,10);

    // ---- AUTENTICACIÓN E INICIO DE APP ----
    switchOnlyMainViews('loadingView');
    supabase.auth.onAuthStateChange(async (_event, session) => {
      DOM.studentView.classList.add('hidden'); DOM.tutorView.classList.add('hidden');
      if (session) {
        const { data: profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
        if (!profile) { showToast('Error al cargar perfil.', 'bg-red-600'); await supabase.auth.signOut(); return; }
        currentUserProfile = profile;
        switchOnlyMainViews('mainAppView');
        if (profile.role === 'tutor') {
          DOM.tutorView.classList.remove('hidden');
          DOM.aulaSelector.innerHTML = (currentUserProfile.managed_aulas || []).map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');
          setupTutorTabs();
          listenToTutorRecords();
        } else {
          DOM.studentView.classList.remove('hidden');
          document.getElementById('student-welcome').textContent = `Bienvenido/a, ${profile.full_name || 'Alumno'}`;
          setupStudentTabs();
          renderPracticeInfo();
          listenToStudentRecords();
          renderWeeklyDiary();
        }
      } else {
        if (recordsSubscription) supabase.removeChannel(recordsSubscription);
        currentUserProfile = null;
        switchOnlyMainViews('loginView');
      }
    });

    // ---- LOGIN Y LOGOUT ----
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('login-button');
      const spin = document.getElementById('login-spinner');
      btn.disabled = true; spin.classList.remove('hidden');
      const { error } = await supabase.auth.signInWithPassword({ 
        email: document.getElementById('login-email').value.trim(), 
        password: document.getElementById('login-password').value 
      });
      if (error) showToast(`Error: ${error.message}`, 'bg-red-600');
      btn.disabled = false; spin.classList.add('hidden');
    });
    document.getElementById('logout-btn-student').addEventListener('click', () => supabase.auth.signOut());
    document.getElementById('logout-btn-tutor').addEventListener('click', () => supabase.auth.signOut());
    
    // ---- PESTAÑAS ALUMNO ----
    function setupStudentTabs() {
        const tabs = ['dashboard', 'new', 'history', 'diary', 'memory'];
        tabs.forEach(tabId => {
            document.getElementById(`tab-student-${tabId}`).addEventListener('click', () => {
                tabs.forEach(id => {
                    document.getElementById(`student-${id}-view`).classList.add('hidden');
                    document.getElementById(`tab-student-${id}`).classList.remove('active');
                });
                document.getElementById(`student-${tabId}-view`).classList.remove('hidden');
                document.getElementById(`tab-student-${tabId}`).classList.add('active');
            });
        });
        document.getElementById('tab-student-dashboard').click();
    }

    // ---- LÓGICA DE ALUMNO ----
    const practiceForm = document.getElementById('practice-form');
    const absenceCheckbox = document.getElementById('absence-checkbox');
    const practiceDate = document.getElementById('practice-date');
    
    practiceDate.valueAsDate = new Date();
    practiceDate.max = todayISO();
    
    absenceCheckbox.addEventListener('change', () => {
        document.getElementById('attendance-fields').classList.toggle('hidden', absenceCheckbox.checked);
        document.getElementById('absence-fields').classList.toggle('hidden', !absenceCheckbox.checked);
        computeHours();
    });
    ['start-time', 'end-time'].forEach(id => document.getElementById(id).addEventListener('input', computeHours));
    
    function computeHours() {
      const startTime = document.getElementById('start-time').value;
      const endTime = document.getElementById('end-time').value;
      const hoursComputed = document.getElementById('hours-computed');
      const warningMessage = document.getElementById('warning-message');

      if (absenceCheckbox.checked) { hoursComputed.textContent = '0.00'; warningMessage.classList.add('hidden'); document.getElementById('submit-button').disabled = false; return; }
      const h = computeDiffHours(startTime, endTime);
      hoursComputed.textContent = h.toFixed(2);
      const invalid = (startTime && endTime && h <= 0) || h > 12;
      warningMessage.classList.toggle('hidden', !invalid);
      document.getElementById('submit-button').disabled = invalid;
    }
    
    practiceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const isAbsent = absenceCheckbox.checked;
        const fileInput = document.getElementById('absence-file');
        const record = {
            alumno_id: currentUserProfile.id,
            aula_id: currentUserProfile.aula_id,
            companyName: document.getElementById('company-name').value.trim(),
            practiceDate: practiceDate.value,
            isAbsent,
            startTime: isAbsent ? null : document.getElementById('start-time').value,
            endTime: isAbsent ? null : document.getElementById('end-time').value,
            activity: isAbsent ? null : document.getElementById('activity-description').value.trim(),
            absenceReason: isAbsent ? document.getElementById('absence-reason').value.trim() : null,
            hours: isAbsent ? 0 : parseFloat(document.getElementById('hours-computed').textContent) || 0,
            status: 'Pendiente',
            attachedFile: isAbsent && fileInput.files.length > 0 ? fileInput.files[0].name : null,
        };

        if (!record.practiceDate || !record.companyName) return showToast('La fecha y la empresa son obligatorias.', 'bg-red-600');
        if (!isAbsent && (!record.startTime || !record.endTime || !record.activity)) return showToast('Completa las horas y la actividad.', 'bg-red-600');
        if (isAbsent && !record.absenceReason) return showToast('Indica el motivo de la ausencia.', 'bg-red-600');

        const btn = document.getElementById('submit-button');
        const spin = document.getElementById('submit-spinner');
        btn.disabled = true; spin.classList.remove('hidden');
        const { error } = await supabase.from('practicas').insert([record]);
        if (error) showToast('Error al guardar el parte.', 'bg-red-600');
        else { showToast('Parte guardado con éxito', 'bg-emerald-600'); practiceForm.reset(); practiceDate.valueAsDate = new Date(); computeHours(); }
        btn.disabled = false; spin.classList.add('hidden');
    });
    
    const listenToStudentRecords = () => {
      if (recordsSubscription) supabase.removeChannel(recordsSubscription);
      recordsSubscription = supabase.channel('student-records').on('postgres_changes', { event: '*', schema: 'public', table: 'practicas', filter: `alumno_id=eq.${currentUserProfile.id}` }, updateStudentViews).subscribe(() => updateStudentViews());
    };

    function updateStudentViews() {
        renderStudentHistory();
        updateStudentStats();
    }

    async function renderStudentHistory() {
      const { data, error } = await supabase.from('practicas').select('*').eq('alumno_id', currentUserProfile.id).order('practiceDate', { ascending: false });
      if (error) return;
      
      document.getElementById('student-history-tbody').innerHTML = (data || []).map(r => `
        <tr class="border-b border-slate-200">
          <td class="px-6 py-4 ${r.isAbsent ? 'text-red-500' : ''}">${escapeHTML(r.practiceDate)}</td>
          <td class="px-6 py-4">${escapeHTML(r.companyName)}</td>
          <td class="px-6 py-4 font-semibold ${r.isAbsent ? 'text-red-500' : ''}">${Number(r.hours || 0).toFixed(2)}</td>
          <td class="px-6 py-4 max-w-xs truncate" title="${escapeHTML(r.isAbsent ? r.absenceReason : r.activity)}">${r.isAbsent ? `Ausencia: ${escapeHTML(r.absenceReason || '')}` : escapeHTML(r.activity || '')}</td>
          <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusStyles[r.status] || statusStyles.default}">${escapeHTML(r.status || 'Pendiente')}</span></td>
        </tr>`).join('');
    }

    async function updateStudentStats() {
        const { data, error } = await supabase.from('practicas').select('hours, isAbsent, status').eq('alumno_id', currentUserProfile.id);
        if(error) return;
        document.getElementById('stat-student-hours').textContent = data.reduce((sum, r) => sum + (r.hours || 0), 0).toFixed(2);
        document.getElementById('stat-student-attended').textContent = data.filter(r => !r.isAbsent).length;
        document.getElementById('stat-student-absences').textContent = data.filter(r => r.isAbsent).length;
        document.getElementById('stat-student-pending').textContent = data.filter(r => r.status === 'Pendiente').length;
    }
    
    function renderPracticeInfo() {
        const info = currentUserProfile.practice_info;
        const container = document.getElementById('practice-info-content');
        if (!info) {
            container.innerHTML = '<p>No se ha cargado la información de las prácticas.</p>';
            return;
        }
        container.innerHTML = `
            <p><strong>Alumno/a:</strong> ${escapeHTML(currentUserProfile.full_name)}</p>
            <p><strong>Email:</strong> ${escapeHTML(currentUserProfile.email)}</p>
            <p><strong>Curso:</strong> ${escapeHTML(info.course)}</p>
            <hr class="border-dashed my-2">
            <p><strong>Tutor/a de Empresa:</strong> ${escapeHTML(info.company_tutor)}</p>
            <p><strong>Tutor/a del Centro:</strong> ${escapeHTML(info.center_tutor)}</p>
            <hr class="border-dashed my-2">
            <p><strong>Periodo:</strong> Del ${escapeHTML(info.start_date)} al ${escapeHTML(info.end_date)}</p>
        `;
    }

    // ---- LÓGICA DIARIO SEMANAL ALUMNO ----
    const diaryDateInput = document.getElementById('diary-date');
    diaryDateInput.valueAsDate = new Date();

    document.getElementById('diary-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const entry = {
            alumno_id: currentUserProfile.id,
            date: diaryDateInput.value,
            description: document.getElementById('diary-description').value.trim(),
            tutor_comment: null
        };
        if (!entry.date || !entry.description) return showToast('Completa la fecha y descripción.', 'bg-red-600');
        await supabase.from('diario_semanal').insert([entry]);
        showToast('Entrada guardada.', 'bg-emerald-600');
        document.getElementById('diary-form').reset();
        diaryDateInput.valueAsDate = new Date();
        renderWeeklyDiary();
    });

    async function renderWeeklyDiary() {
        const { data: entries } = await supabase.from('diario_semanal').select('*').eq('alumno_id', currentUserProfile.id).order('date', { ascending: false });
        const container = document.getElementById('diary-entries');
        if (!entries || entries.length === 0) {
            container.innerHTML = `<p class="text-slate-500 text-center py-4">Aún no hay entradas en tu diario.</p>`;
            return;
        }
        container.innerHTML = entries.map(entry => `
            <div class="bg-amber-50/50 border border-amber-100 rounded-lg p-4">
                <p class="font-bold text-slate-800 text-sm">${new Date(entry.date + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p class="text-slate-600 whitespace-pre-wrap font-notes text-lg">${escapeHTML(entry.description)}</p>
                ${entry.tutor_comment ? `
                    <div class="mt-3 pt-3 border-t border-dashed border-amber-200">
                        <p class="text-sm font-bold text-indigo-700">Comentario del Tutor:</p>
                        <p class="text-indigo-800/80 italic font-notes text-base">${escapeHTML(entry.tutor_comment)}</p>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }
    
    // ---- LÓGICA MEMORIA FINAL ALUMNO ----
    document.getElementById('memory-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const company = document.getElementById('memory-company').value;
        const tasks = document.getElementById('memory-tasks').value;
        const skills = document.getElementById('memory-skills').value;
        const conclusion = document.getElementById('memory-conclusion').value;
        const info = currentUserProfile.practice_info;
        const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

        const memoryHTML = `
            <html>
                <head>
                    <title>Memoria de Prácticas - ${escapeHTML(currentUserProfile.full_name)}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
                        body { 
                            font-family: 'Inter', sans-serif;
                            -webkit-print-color-adjust: exact; /* Ensures colors print correctly in Chrome */
                            print-color-adjust: exact;
                        }
                        @page {
                            margin: 1in;
                        }
                        .section-title {
                            border-bottom: 1px solid #e2e8f0; /* slate-200 */
                            padding-bottom: 8px;
                            margin-top: 2.5rem;
                            color: #1e293b; /* slate-800 */
                        }
                        .content-p {
                            white-space: pre-wrap;
                            margin-top: 1rem;
                            line-height: 1.75;
                            color: #475569; /* slate-600 */
                        }
                    </style>
                </head>
                <body class="bg-white text-slate-900">
                    <main class="max-w-4xl mx-auto p-4 md:p-8">
                        <header class="text-center mb-16">
                            <h1 class="text-4xl font-bold text-slate-800">Memoria de Prácticas FCT</h1>
                            <p class="text-lg text-slate-500 mt-2">${escapeHTML(info?.course || 'Ciclo Formativo')}</p>
                        </header>

                        <section class="bg-slate-50 border border-slate-200 rounded-lg p-6">
                            <h2 class="text-xl font-bold text-slate-700 mb-4">Detalles del Alumno</h2>
                            <div class="grid grid-cols-2 gap-x-8 gap-y-3 text-slate-600">
                                <div><strong>Alumno/a:</strong> ${escapeHTML(currentUserProfile.full_name)}</div>
                                <div><strong>Tutor/a Centro:</strong> ${escapeHTML(info?.center_tutor || 'N/A')}</div>
                                <div><strong>Email:</strong> ${escapeHTML(currentUserProfile.email)}</div>
                                <div><strong>Tutor/a Empresa:</strong> ${escapeHTML(info?.company_tutor || 'N/A')}</div>
                                <div class="col-span-2"><strong>Periodo de Prácticas:</strong> ${escapeHTML(info?.start_date || 'N/A')} al ${escapeHTML(info?.end_date || 'N/A')}</div>
                            </div>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold section-title">1. Descripción de la Empresa</h2>
                            <p class="content-p">${escapeHTML(company)}</p>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold section-title">2. Resumen de Tareas Realizadas</h2>
                            <p class="content-p">${escapeHTML(tasks)}</p>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold section-title">3. Competencias Adquiridas</h2>
                            <p class="content-p">${escapeHTML(skills)}</p>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold section-title">4. Valoración Personal y Conclusiones</h2>
                            <p class="content-p">${escapeHTML(conclusion)}</p>
                        </section>

                        <footer class="text-center text-sm text-slate-400 mt-20 pt-8 border-t">
                            <p>Memoria generada el ${today}</p>
                            <p>${escapeHTML(currentUserProfile.full_name)}</p>
                        </footer>
                    </main>
                </body>
            </html>
        `;
        
        const win = window.open("", "Memoria Final");
        win.document.write(memoryHTML);
        win.document.close();
        win.print();
    });

    // ---- PESTAÑAS TUTOR Y PLAN DE ACOGIDA ----
    function setupTutorTabs() {
        document.getElementById('tab-tutor-records').addEventListener('click', () => {
            document.getElementById('tutor-records-view').classList.remove('hidden');
            document.getElementById('tutor-onboarding-view').classList.add('hidden');
            document.getElementById('tab-tutor-records').classList.add('active');
            document.getElementById('tab-tutor-onboarding').classList.remove('active');
        });
        document.getElementById('tab-tutor-onboarding').addEventListener('click', () => {
            document.getElementById('tutor-records-view').classList.add('hidden');
            document.getElementById('tutor-onboarding-view').classList.remove('hidden');
            document.getElementById('tab-tutor-records').classList.remove('active');
            document.getElementById('tab-tutor-onboarding').classList.add('active');
            renderOnboardingPlan();
        });
    }

    function renderOnboardingPlan() {
        const plan = [
            { title: 'Una Semana Antes de la Incorporación', tasks: [
                "Informar al equipo de la llegada del alumno y del proyecto de FP.",
                "Preparar su espacio de trabajo (mesa, ordenador, accesos, etc.).",
                "Asignar EPIS, uniforme o material de trabajo necesario.",
                "Confirmar con el alumno la fecha, hora y persona de contacto para su primer día."
            ]},
            { title: 'El Día de la Llegada', tasks: [
                "Realizar una bienvenida formal y presentar al tutor y al equipo directo.",
                "Entregar y revisar la documentación necesaria (convenio, plan formativo, etc.).",
                "Realizar una visita guiada por las instalaciones.",
                "Explicar las normas básicas de la empresa (horarios, descansos, seguridad).",
                "Revisar conjuntamente el plan de formación, explicando las primeras tareas.",
                "Asignar una primera tarea sencilla para facilitar la adaptación."
            ]},
            { title: 'Durante la Primera Semana', tasks: [
                "Realizar reuniones cortas de seguimiento al inicio y final de cada día.",
                "Fomentar la interacción con el resto del equipo.",
                "Aclarar dudas sobre las tareas y el funcionamiento de la empresa.",
                "Dar feedback constructivo sobre las primeras tareas realizadas."
            ]}
        ];
        document.getElementById('onboarding-plan-content').innerHTML = plan.map(section => `
            <div>
                <h3 class="text-xl font-bold font-handwriting text-slate-700 mb-3">${section.title}</h3>
                <ul class="list-disc list-inside space-y-2 text-slate-600 font-notes text-lg">
                    ${section.tasks.map(task => `<li>${task}</li>`).join('')}
                </ul>
            </div>
        `).join('<hr class="my-6 border-dashed">');
    }

    // ---- LÓGICA DE TUTOR ----
    const listenToTutorRecords = () => {
        if (recordsSubscription) supabase.removeChannel(recordsSubscription);
        recordsSubscription = supabase.channel('tutor-records').on('postgres_changes', { event: '*', schema: 'public', table: 'practicas' }, fetchAndRenderTutorTable).subscribe(() => fetchAndRenderTutorTable());
    };
    const fetchAndRenderTutorTable = async () => {
      const selectedAulaId = DOM.aulaSelector.value;
      if(!selectedAulaId) return;
      document.getElementById('tutor-welcome').textContent = `Gestionando el aula: ${DOM.aulaSelector.options[DOM.aulaSelector.selectedIndex].text}`;
      const { data, error } = await supabase.from('practicas').select('*, profile:profiles(full_name, practice_info)').eq('aula_id', selectedAulaId).order('practiceDate', { ascending: false });
      if (error) { console.error(error); return; }
      allTutorRecords = data || [];
      currentPage = 1;
      renderTutorTable();
    };

    const applyTutorFilters = () => {
      const student = document.getElementById('filter-student').value.toLowerCase();
      const company = document.getElementById('filter-company').value.toLowerCase();
      const from = document.getElementById('filter-date-from').value;
      const to = document.getElementById('filter-date-to').value;
      return allTutorRecords.filter(r =>
        (r.profile?.full_name || '').toLowerCase().includes(student) &&
        (r.companyName || '').toLowerCase().includes(company) &&
        (!from || r.practiceDate >= from) &&
        (!to || r.practiceDate <= to)
      );
    };
    
    const renderTutorTable = () => {
      const filtered = applyTutorFilters();
      document.getElementById('stat-total-records').textContent = filtered.length;
      document.getElementById('stat-total-hours').textContent = filtered.reduce((sum, r) => sum + (r.hours || 0), 0).toFixed(2);
      document.getElementById('stat-total-absences').textContent = filtered.filter(r => r.isAbsent).length;

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      currentPage = Math.min(currentPage, totalPages);
      const pageItems = filtered.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE);

      document.getElementById('records-tbody').innerHTML = pageItems.map(r => `
        <tr class="border-b border-slate-200 hover:bg-amber-50/50">
          <td class="px-6 py-4">${escapeHTML(r.profile?.full_name || '')}</td>
          <td class="px-6 py-4 font-medium ${r.isAbsent ? 'text-red-600' : ''}">${escapeHTML(r.practiceDate)}</td>
          <td class="px-6 py-4">${escapeHTML(r.companyName || '')}</td>
          <td class="px-6 py-4 font-semibold ${r.isAbsent ? 'text-red-600' : ''}">${Number(r.hours || 0).toFixed(2)}</td>
          <td class="px-6 py-4 max-w-xs truncate" title="${escapeHTML(r.isAbsent ? r.absenceReason : r.activity)}">
            ${r.isAbsent ? `<span class='font-semibold'>Ausencia:</span> ${escapeHTML(r.absenceReason || 'Sin motivo')}` : escapeHTML(r.activity || '')}
            ${r.attachedFile ? `<a href="#" class="ml-2 text-indigo-600" title="Descargar ${escapeHTML(r.attachedFile)}"><i class="fas fa-paperclip"></i></a>` : ''}
          </td>
          <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusStyles[r.status] || statusStyles.default}">${escapeHTML(r.status || 'Pendiente')}</span></td>
          <td class="px-6 py-4 text-right"><div class="flex items-center justify-end gap-3">
              <button data-student-id="${r.alumno_id}" data-student-name="${escapeHTML(r.profile?.full_name)}" class="diary-btn text-cyan-600 hover:text-cyan-900 text-lg" title="Ver Diario"><i class="fas fa-book-reader"></i></button>
              <button data-id="${r.id}" class="evaluation-btn text-blue-600 hover:text-blue-900 text-lg" title="Evaluar"><i class="fas fa-clipboard-check"></i></button>
              <button data-id="${r.id}" class="edit-btn text-indigo-600 hover:text-indigo-900 text-lg" title="Editar"><i class="fas fa-pencil-alt"></i></button>
              <button data-id="${r.id}" class="delete-btn text-red-600 hover:text-red-900 text-lg" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
          </div></td>
        </tr>`).join('');

      document.getElementById('page-indicator').textContent = `Página ${currentPage} / ${totalPages}`;
      document.getElementById('prev-page').disabled = currentPage <= 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;
    };
    
    DOM.aulaSelector.addEventListener('change', fetchAndRenderTutorTable);
    document.getElementById('records-tbody').addEventListener('click', (e) => {
      const button = e.target.closest('button');
      if (!button) return;
      const id = button.getAttribute('data-id');
      if (button.classList.contains('diary-btn')) openDiaryModal(button.dataset.studentId, button.dataset.studentName);
      if (button.classList.contains('evaluation-btn')) openEvaluationModal(id);
      if (button.classList.contains('edit-btn')) openEditModal(id);
      if (button.classList.contains('delete-btn')) openDeleteModal(id);
    });
    document.getElementById('prev-page').addEventListener('click', () => { if(currentPage > 1) { currentPage--; renderTutorTable(); } });
    document.getElementById('next-page').addEventListener('click', () => { 
        const totalPages = Math.ceil(applyTutorFilters().length / PAGE_SIZE);
        if (currentPage < totalPages) { currentPage++; renderTutorTable(); }
    });
    ['filter-student', 'filter-company', 'filter-date-from', 'filter-date-to'].forEach(id => document.getElementById(id).addEventListener('input', debounce(() => { currentPage = 1; renderTutorTable(); }, 200)));
    document.getElementById('clear-filters').addEventListener('click', () => {
      ['filter-student', 'filter-company', 'filter-date-from', 'filter-date-to'].forEach(id => document.getElementById(id).value = '');
      currentPage = 1; renderTutorTable();
    });
    
    // ---- LÓGICA DE MODALES ----
    const openDeleteModal = (id) => { recordIdToMutate = id; DOM.confirmDeleteModal.classList.remove('hidden'); };
    document.getElementById('cancel-delete-btn').addEventListener('click', () => DOM.confirmDeleteModal.classList.add('hidden'));
    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
        const { error } = await supabase.from('practicas').eq('id', recordIdToMutate).delete();
        if (error) showToast('Error al eliminar.', 'bg-red-500');
        else showToast('Registro eliminado.', 'bg-emerald-600');
        DOM.confirmDeleteModal.classList.add('hidden');
    });
    
    const openEditModal = (id) => {
      const r = allTutorRecords.find(x => x.id == id);
      if (!r) return;
      recordIdToMutate = id;
      document.getElementById('edit-record-id').value = id;
      document.getElementById('edit-student-name').value = r.profile?.full_name || '';
      document.getElementById('edit-company-name').value = r.companyName || '';
      document.getElementById('edit-practice-date').value = r.practiceDate || '';
      document.getElementById('edit-start-time').value = r.startTime || '';
      document.getElementById('edit-end-time').value = r.endTime || '';
      document.getElementById('edit-hours').value = Number(r.hours || 0).toFixed(2);
      document.getElementById('edit-activity').value = r.isAbsent ? (r.absenceReason || '') : (r.activity || '');
      document.getElementById('edit-activity-label').textContent = r.isAbsent ? 'Motivo Ausencia' : 'Actividad Realizada';
      document.getElementById('edit-status').value = r.status || 'Pendiente';
      DOM.editRecordModal.classList.remove('hidden');
    };
    document.getElementById('close-edit-modal').addEventListener('click', () => DOM.editRecordModal.classList.add('hidden'));
    
    document.getElementById('edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const originalRecord = allTutorRecords.find(x => x.id == recordIdToMutate);
        const hrs = computeDiffHours(document.getElementById('edit-start-time').value, document.getElementById('edit-end-time').value);
        const updatedData = {
            companyName: document.getElementById('edit-company-name').value.trim(),
            practiceDate: document.getElementById('edit-practice-date').value,
            status: document.getElementById('edit-status').value,
            startTime: originalRecord.isAbsent ? null : document.getElementById('edit-start-time').value,
            endTime: originalRecord.isAbsent ? null : document.getElementById('edit-end-time').value,
            hours: originalRecord.isAbsent ? 0 : hrs,
            activity: originalRecord.isAbsent ? null : document.getElementById('edit-activity').value.trim(),
            absenceReason: originalRecord.isAbsent ? document.getElementById('edit-activity').value.trim() : null,
        };
        const { error } = await supabase.from('practicas').eq('id', recordIdToMutate).update(updatedData);
        if (error) showToast('Error al actualizar.', 'bg-red-500');
        else { showToast('Registro actualizado.', 'bg-emerald-600'); DOM.editRecordModal.classList.add('hidden'); }
    });

    // ---- MEJORA: Cálculo de horas en tiempo real en Modal de Edición ----
    const updateEditModalHours = () => {
        const originalRecord = allTutorRecords.find(x => x.id == recordIdToMutate);
        if (originalRecord && !originalRecord.isAbsent) {
            const startTime = document.getElementById('edit-start-time').value;
            const endTime = document.getElementById('edit-end-time').value;
            const h = computeDiffHours(startTime, endTime);
            document.getElementById('edit-hours').value = h.toFixed(2);
        }
    };
    document.getElementById('edit-start-time').addEventListener('input', updateEditModalHours);
    document.getElementById('edit-end-time').addEventListener('input', updateEditModalHours);
    
    // ---- LÓGICA MODALES DE EVALUACIÓN Y DIARIO (TUTOR) ----
    const openEvaluationModal = (id) => {
        const record = allTutorRecords.find(r => r.id == id);
        if (!record) return;
        recordIdToMutate = id;
        document.getElementById('evaluation-record-id').value = id;
        document.getElementById('evaluation-student-name').textContent = record.profile?.full_name || 'N/A';
        const evalData = record.evaluation || { responsabilidad: 5, iniciativa: 5, equipo: 5, comunicacion: 5, comentarios: '' };
        document.getElementById('eval-responsabilidad').value = evalData.responsabilidad;
        document.getElementById('eval-iniciativa').value = evalData.iniciativa;
        document.getElementById('eval-equipo').value = evalData.equipo;
        document.getElementById('eval-comunicacion').value = evalData.comunicacion;
        document.getElementById('eval-comentarios').value = evalData.comentarios;
        DOM.evaluationModal.classList.remove('hidden');
    };
    document.getElementById('close-evaluation-modal').addEventListener('click', () => DOM.evaluationModal.classList.add('hidden'));
    document.getElementById('evaluation-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const evaluation = {
            responsabilidad: document.getElementById('eval-responsabilidad').value,
            iniciativa: document.getElementById('eval-iniciativa').value,
            equipo: document.getElementById('eval-equipo').value,
            comunicacion: document.getElementById('eval-comunicacion').value,
            comentarios: document.getElementById('eval-comentarios').value.trim(),
        };
        const { error } = await supabase.from('practicas').eq('id', recordIdToMutate).update({ evaluation, status: 'Validado' });
        if (error) { showToast('Error al guardar la evaluación.', 'bg-red-500'); } 
        else { showToast('Evaluación guardada y parte validado.', 'bg-emerald-600'); DOM.evaluationModal.classList.add('hidden'); }
    });
    
    document.getElementById('close-diary-modal').addEventListener('click', () => DOM.diaryModal.classList.add('hidden'));
    const openDiaryModal = async (studentId, studentName) => {
        document.getElementById('diary-modal-student-name').textContent = studentName;
        const { data: entries } = await supabase.from('diario_semanal').select('*').eq('alumno_id', studentId).order('date', { ascending: false });
        const container = document.getElementById('diary-modal-content');
        if (!entries || entries.length === 0) {
            container.innerHTML = `<p class="text-slate-500 text-center py-4">Este alumno aún no tiene entradas en su diario.</p>`;
        } else {
            container.innerHTML = entries.map(entry => {
                const commentHTML = entry.tutor_comment
                    ? `<p class="text-sm font-bold text-indigo-700">Tu Comentario:</p><p class="text-indigo-800/80 italic font-notes text-base">${escapeHTML(entry.tutor_comment)}</p>`
                    : `<form class="comment-form" data-entry-id="${entry.id}">
                            <textarea class="styled-textarea w-full text-sm" rows="2" placeholder="Añadir un comentario..."></textarea>
                            <div class="text-right mt-2">
                                <button type="submit" class="bg-indigo-600 text-white text-xs font-semibold py-1 px-3 rounded-lg hover:bg-indigo-700">Guardar</button>
                            </div>
                        </form>`;

                return `<div class="bg-amber-50/50 border border-amber-100 rounded-lg p-4">
                        <p class="font-bold text-slate-800 text-sm">${new Date(entry.date + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                        <p class="text-slate-600 whitespace-pre-wrap font-notes text-lg">${escapeHTML(entry.description)}</p>
                        <div class="mt-3 pt-3 border-t border-dashed border-amber-200">
                            ${commentHTML}
                        </div>
                    </div>`;
            }).join('');
        }
        DOM.diaryModal.classList.remove('hidden');
    };

    document.getElementById('diary-modal-content').addEventListener('submit', async function(e) {
        if (e.target.classList.contains('comment-form')) {
            e.preventDefault();
            const entryId = e.target.dataset.entryId;
            const commentText = e.target.querySelector('textarea').value.trim();
            if (!commentText) return;
            
            const { error } = await supabase.from('diario_semanal').eq('id', entryId).update({ tutor_comment: commentText });
            if(error) {
                showToast('Error al guardar comentario.', 'bg-red-600');
            } else {
                showToast('Comentario guardado.', 'bg-emerald-600');
                DOM.diaryModal.classList.add('hidden');
            }
        }
    });

    // ---- EXPORTACIÓN A CSV ----
    document.getElementById('export-csv-btn').addEventListener('click', () => {
      const rows = applyTutorFilters();
      if (!rows.length) { showToast('No hay datos que exportar.', 'bg-slate-700'); return; }
      const headers = ['Alumno','Fecha','Empresa','Horas','Actividad/Motivo','Estado', 'Fichero Adjunto', 'Eval. Responsabilidad', 'Eval. Iniciativa', 'Eval. Equipo', 'Eval. Comunicación', 'Eval. Comentarios'];
      const csv = [headers.join(';')].concat(rows.map(r => [
        (r.profile?.full_name || ''), (r.practiceDate || ''), (r.companyName || ''),
        (Number(r.hours || 0).toFixed(2).replace('.',',')),
        (r.isAbsent ? `Ausencia: ${r.absenceReason || ''}` : (r.activity || '')),
        (r.status || 'Pendiente'), (r.attachedFile || ''),
        (r.evaluation?.responsabilidad || ''), (r.evaluation?.iniciativa || ''), (r.evaluation?.equipo || ''), (r.evaluation?.comunicacion || ''), (r.evaluation?.comentarios || '')
      ].map(v => '"' + String(v).replaceAll('"','""') + '"').join(';'))).join('\n');
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `practicas_${DOM.aulaSelector.options[DOM.aulaSelector.selectedIndex].text}_${todayISO()}.csv`; a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>

